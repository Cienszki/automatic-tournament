
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check for admin privileges.
    function isAdmin() {
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Helper function to check if the user is a captain of a specific team.
    function isCaptain(teamId) {
      return request.auth.uid == get(/databases/$(database)/documents/teams/$(teamId)).data.captainId;
    }

    // Helper to check if the user is a captain of a team in a match.
    function isCaptainOfMatch(matchId) {
      let teamA_Id = get(/databases/$(database)/documents/matches/$(matchId)).data.teamA.id;
      let teamB_Id = get(/databases/$(database)/documents/matches/$(matchId)).data.teamB.id;
      return isCaptain(teamA_Id) || isCaptain(teamB_Id);
    }

    // Global deny-all rule (except for specific matches below)
    match /{document=**} {
      allow read, write: if false;
    }

    // --- PUBLIC READABLE COLLECTIONS ---
    match /announcements/{docId} { allow read: if true; }
    match /teams/{docId} { allow read: if true; }
    match /matches/{docId} { allow read: if true; }
    match /groups/{docId} { allow read: if true; }
    match /stages/{docId} { allow read: if true; }
    match /configs/{docId} { allow read: if true; }
    match /tournament/{docId} { allow read: if true; }
    match /fantasyLineups/{userId} { allow read: if true; }
    match /players/{playerId} { allow read: if true; }

    // --- USER-SPECIFIC WRITE RULES ---
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId || isAdmin();
    }
    
    match /pickems/{userId} { // CORRECTED SPELLING
      allow read: if true;
      allow write: if request.auth.uid == userId || isAdmin();
    }

    match /fantasyLineups/{userId} {
      allow read: if true;
      allow write: if request.auth.uid == userId || isAdmin();
      match /rounds/{roundId} {
        allow read: if true; // Allow public read for leaderboard functionality
        allow write: if request.auth.uid == userId || isAdmin();
      }
    }

    // --- ADMIN-ONLY WRITE RULES ---
    match /announcements/{docId} { allow write: if isAdmin(); }
    match /groups/{docId} { allow write: if isAdmin(); }
    match /stages/{docId} { allow write: if isAdmin(); }
    match /configs/{docId} { allow write: if isAdmin(); }
    match /tournament/{docId} { allow write: if isAdmin(); }
    match /firebase-frameworks-hosting-controlled-rollouts/{rolloutId} { allow write: if isAdmin(); }


    // --- COMPLEX RULES ---
    match /teams/{teamId} {
      allow read: if true;
      allow write: if request.auth.uid != null;
      allow delete: if isAdmin();

      match /players/{playerId} {
        allow read: if true;
        allow write: if request.auth.uid != null;
        allow delete: if isAdmin();
      }
    }

    match /matches/{matchId} {
      allow create, delete: if isAdmin();
      allow update: if isCaptainOfMatch(matchId) || isAdmin();
      
      // Subcollections for match games
      match /games/{gameId} {
        allow read: if true;
        allow write: if isAdmin();
        
        match /performances/{playerId} {
          allow read: if true;
          allow write: if isAdmin();
        }
      }
    }

    // --- ADMIN-ONLY COLLECTIONS ---
    match /processedGames/{gameId} {
      allow read, write: if isAdmin();
    }
    
    match /blockedGames/{gameId} {
      allow read, write: if isAdmin();
    }
  }
}
